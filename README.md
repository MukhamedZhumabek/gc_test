
## Тестовое приложение Global Coffee Test

 -это простой CRUD  c тестами

Стэк:

- Python3.10.4
- FastAPI
- SQLalchemy2
- PostgreSQL
- Alembic
- Pytest
- Docker, Docker-Compose
---
# Навигация

- [Быстро развернуть](#как-быстро-поднять-проект)
- [Развернуть для локально для работы](#развернуть-локально-для-разработки)
- [Описание моделей в БД](#модели-данных)
- [Структура проекта](#cтруктура-проекта)
- [API](#api)

---

## Как быстро поднять проект?
<a name="быстро-развернуть"></a>
### 1. Склонировать репозиторий

https
```console
git clone https://github.com/MukhamedZhumabek/gc_test.git && cd gc_test
```
ssh
```console
git clone git@github.com:MukhamedZhumabek/gc_test.git && cd gc_test
```
### 2. Поднять docker-compose
 - app(fastapi)   :8000
 - db(postgresql) :5432
```console
docker-compose up -d
```

### 3. Прогнать тесты и убедиться что все работает
```console
docker-compose exec app python -m pytest -v
```

### 4. У FastApi есть swagger из коробки 
>[Потыкать API](http://127.0.0.1:8000/docs)
---
## Развернуть локально для разработки
<a name="развернуть-локально"></a>
1. Опустить контейнеры

```console
docker-compose down
```
2. В файле `settings.py` заменить `.env.postgres` на `.env.postgres.local`


3. Создать виртульное окружение
```console
python3 -m venv .venv
```
```console
source .venv/bin/activate
```
```console
pip install -r requirements.txt
```

4. Поднять базу данных
```console
docker-compose -f docker-compose.local.yml up -d
```
5. Накатить миграции если нужно
```console
alembic upgrade heads
```
4. Прогнать тесты и убедиться что проект нормально завелся
```console
python -m pytest -v
```

Что бы не париться с запуском проекта в пайчарме можно просто добавить в файл `main.py`, в таком случается не забудьте импортировать `uvicorn`
```python
if __name__ == '__main__':
    uvicorn.run(app=gc_test_app)
```

покажите Pycharm где находиться ваше виртуальное окружение и запускайте.

---

Вот описание моделей данных:

---
# Cтруктура проекта

Грубо говоря это обычный MVC проект

В проекте следующая структура файлов и директорий:

- **`api/`**: все что нужно для API 
  - **`data_model/`**: Модели для валидации данных (Pydantic)
  - **`router/`**: Роутеры (FastAPI)
- **`db/`**: Подключение к БД и модели (SQLAlchemy)
- **`manager/`**: Менеджеры для связки web и DB (DAL), тут выполняется бизнеc логика
- **`migrations`**: Миграции (Alembic)
- `test/`: тесты (Pytest)
- `main.py` - точка входа в приложение
- `docker-compose.yml` - что поднять все в контейнерах
- `docker-compose.local.yml` - поднять только DB
- `settings.py` - настройки и получение ENV переменных
- `*.ini` - конфигурационные файлы
- `.env.*` - файлы с настройками окружения
- `Dockerfile` - для сервиса app в `docker-compose.yml`
- `requirements.txt` - список зависимостей
# Модели данных

### Product


- **id**: Целое число - уникальный идентификатор продукта.
- **name**: Строка - название продукта.
- **external_id**: Строка - внешний идентификатор продукта, уникальный в пределах системы.
- **description**: Словарь - дополнительная информация о продукте.

- #### Связи:

- **store**: Связь с моделью `Store`, указывающая на магазин, в котором доступен данный продукт.

### Store

- **id**: Целое число - уникальный идентификатор магазина.
- **name**: Строка - название магазина, уникальное в пределах системы.
- **description**: Строка (опционально) - дополнительная информация о магазине.
- **address**: Строка (опционально) - физический адрес магазина.

- #### Связи:

- **products**: Связь с моделью `Product`, указывающая на продукты, доступные в данном магазине.

---

# API

#### если проект поднят, то удобнее смотреть в [OpenAPI](http://127.0.0.1:8000/docs)

## Аутентификация и Aвторизация

Все запросы к  API требуют включения заголовка `auth-token`.

Сейчас за отсутсвием остальной инфраструктуры, захардкожен токен `secret`

Пользователь с токеном `secret` получает авторизацию на полный API

```json
{'auth-token': 'secret'}
```

## API для магазинов

### Получить магазин по ID

- **URL**: `/api/v1/store/{store_id}`
- **Метод**: `GET`
- **Описание**: Получить магазин по его внешнему ID.
- **Параметры**:
  - `store_id` (путь): Целое число - ID магазина
- **Заголовки запроса**:
  - `auth-token`: Строка - Аутентификационный токен
- **Ответы**:
  - `200 OK`: Успешный ответ. Возвращает детали магазина.
  - `404 Ошибка запроса`: Магазин не найден
  - `422 Ошибка валидации`: Если есть ошибка в параметрах запроса.

### Создать новый магазин

- **URL**: `/api/v1/store/`
- **Метод**: `POST`
- **Описание**: Создать новый магазин.
- **Заголовки запроса**:
  - `auth-token`: Строка - Аутентификационный токен
- **Тело запроса**:
  - JSON-объект с следующими свойствами:
    - `name`: Строка - Название магазина
    - `description`: Строка (опционально) - Описание магазина
    - `address`: Строка (опционально) - Адрес магазина
- **Ответы**:
  - `200 OK`: Успешный ответ. Возвращает детали созданного магазина.
  - `400 Неправильные данные`: Если есть ошибка в логике запроса.
  - `422 Ошибка валидации`: Если есть ошибка в параметрах запроса.

## APi для Product

### Получить продукт по внешнему ID

- **URL**: `/api/v1/product/{external_id}`
- **Метод**: `GET`
- **Описание**: Получить продукт по его внешнему ID.
- **Параметры**:
  - `external_id` (путь): Строка - Внешний ID продукта
- **Заголовки запроса**:
  - `auth-token`: Строка - Аутентификационный токен
- **Ответы**:
  - `200 OK`: Успешный ответ. Возвращает детали продукта.
  - `404 Ошибка запроса`: Продукт не найден
  - `422 Ошибка валидации`: Если есть ошибка в параметрах запроса.

### Создать новый продукт

- **URL**: `/api/v1/product/`
- **Метод**: `POST`
- **Описание**: Создать новый продукт.
- **Заголовки запроса**:
  - `auth-token`: Строка - Аутентификационный токен
- **Тело запроса**:
  - JSON-объект с следующими свойствами:
    - `external_id`: Строка - Внешний ID продукта
    - `name`: Строка - Название продукта
    - `description`: Строка (опционально) - Описание продукта
    - `store_id`: Целое число - ID магазина, к которому принадлежит продукт
- **Ответы**:
  - `200 OK`: Успешный ответ. Возвращает детали созданного продукта.
  - `400 Неправильные данные`: Если есть ошибка в логике запроса.
  - `422 Ошибка валидации`: Если есть ошибка в параметрах запроса.

### Обновить продукт

- **URL**: `/api/v1/product/{external_id}/{store_id}`
- **Метод**: `PUT`
- **Описание**: Обновить продукт по его внешнему ID и ID магазина.
- **Заголовки запроса**:
  - `auth-token`: Строка - Аутентификационный токен
- **Тело запроса**:
  - JSON-объект с следующими свойствами:
    - `name`: Строка - Название продукта
    - `description`: Строка (опционально) - Описание продукта
- **Ответы**:
  - `200 OK`: Успешный ответ. Возвращает детали обновленного продукта.
  - `400 Неправильные данные`: Если есть ошибка в логике запроса.
  - `422 Ошибка валидации`: Если есть ошибка в параметрах запроса.

### Удалить продукт

- **URL**: `/api/v1/product/{external_id}/{store_id}`
- **Метод**: `DELETE`
- **Описание**: Удалить продукт по его внешнему ID и ID магазина.
- **Параметры**:
  - `external_id` (путь): Строка - Внешний ID продукта
  - `store_id` (путь): Целое число - ID магазина, к которому принадлежит продукт
- **Заголовки запроса**:
  - `auth-token`: Строка - Аутентификационный токен
- **Ответы**:
  - `200 OK`: Успешный ответ. Возвращает детали удаленного продукта.
  - `404 Ошибка запроса`: Продукт не найден
  - `422 Ошибка валидации`: Если есть ошибка в параметрах запроса.